trigger:
  - main

variables:
  nodeVersion: '20.x'
  artifactName: 'drop'
  npmCacheDir: '$(Pipeline.Workspace)/.npm'

stages:
  - stage: BuildAndTest
    displayName: Excel Playwright tests
    jobs:
      - job: BuildJob
        displayName: Run Excel tests
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          # configure npm cache
          - script: |
              mkdir -p $(npmCacheDir)
              npm config set cache $(npmCacheDir)
            displayName: 'Configure npm cache'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: '$(npmCacheDir)'
            displayName: 'Cache NPM'

          - script: |
              npm ci
            displayName: 'Install dependencies'

          # install ONLY Chrome
          - script: |
              npx playwright install chrome
              sudo npx playwright install-deps chrome
            displayName: 'Install Chrome for Playwright'

          # run ONLY your npm script
          - script: |
              npm run test:excel -- --forbid-only --reporter=junit
            displayName: 'Run Playwright Excel tests'

          - task: PublishTestResults@2
            displayName: 'Publish test results (JUnit)'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: true
