trigger:
  - main

variables:
  nodeVersion: '20.x'
  npmCacheDir: '$(Pipeline.Workspace)/.npm'

stages:
  - stage: BuildAndTest
    displayName: Playwright Excel Tests
    jobs:
      - job: RunExcelTests
        displayName: Run Playwright Excel Tests
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: |
              mkdir -p $(npmCacheDir)
              npm config set cache $(npmCacheDir)
            displayName: 'Configure npm cache'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: '$(npmCacheDir)'
            displayName: 'Cache npm modules'

          - script: |
              npm ci
            displayName: 'Install dependencies'

          # Install Playwright browser binaries
          - script: |
              npx playwright install chromium
              sudo npx playwright install-deps chromium
            displayName: 'Install Playwright Chromium'

          # Debug listing before test run
          - script: |
              echo "Listing workspace before tests:"
              ls -R
            displayName: 'Debug: list files before tests'

          # Run Playwright tests and generate JUnit + HTML
          - script: |
              mkdir -p test-results
              npx playwright test \
                --reporter=junit=test-results/junit.xml,html \
                --forbid-only
            displayName: 'Run Playwright tests (JUnit + HTML)'

          # Debug listing after test run
          - script: |
              echo "Listing workspace after tests:"
              ls -R
            displayName: 'Debug: list files after tests'

          # Publish JUnit to Tests tab
          - task: PublishTestResults@2
            displayName: 'Publish results to Tests tab'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/junit.xml'
              mergeTestResults: true
              testRunTitle: 'Playwright UI automation tests'
              failTaskOnFailedTests: false

          # Publish HTML report (steps, screenshots, trace viewer)
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-html-report'
            displayName: 'Publish Playwright HTML report'
